# 部署说明（服务器上线）

本说明覆盖两类部署：

- 纯静态站点（仅前端页面与资源）
- 静态站点 + Python 后端 API（FastAPI/uvicorn，可选）

> 推荐使用 Nginx 作为静态资源服务器，必要时将 `/api` 反向代理到后端服务。

## 项目结构（关键目录）

```
32_Characters/
├── Females/                 # 前端站点根目录（index.html 等）
│   ├── index.html
│   ├── npc-game.js
│   ├── reports.js
│   ├── reports.css
│   ├── styles.css           # 如有全局样式
│   ├── IPix.ttf             # 像素字体
│   ├── LOGO.png             # 站点 LOGO
│   ├── *.png / *.mp3 / *.wav 等静态资源
│   └── ...                  # 其他页面与素材
├── backend/                 # 可选后端（FastAPI）
│   └── app/
│       └── main.py          # FastAPI 入口：`app = FastAPI(...)`
└── 部署说明.md               # 本文件
```

## 部署方案 A：纯静态站点（Nginx）

1) 服务器准备

- 安装 Nginx（Ubuntu/Debian：`sudo apt install nginx`）。
- 创建站点目录，例如：`/var/www/mhh/Females`。

2) 拷贝前端文件

- 将本地 `Females/` 整个目录拷贝到服务器的 `/var/www/mhh/Females`：

```
scp -r ./Females/ user@server:/var/www/mhh/Females
```

3) Nginx 站点配置（示例）

将站点根直接指向 `Females`，默认首页为 `index.html`。

```
server {
    listen 80;
    server_name example.com;               # 替换为你的域名或服务器IP

    root /var/www/mhh/Females;             # 指向 Females 目录
    index index.html;

    # 常规静态资源
    location / {
        try_files $uri $uri/ /index.html;  # 如为多页面也可改为 $uri $uri/ =404
    }

    # 字体跨域（若字体与页面不同域名时需要）
    location ~* \.(ttf|woff|woff2)$ {
        add_header Access-Control-Allow-Origin "*";
    }

    # 静态缓存（可选）
    location ~* \.(png|jpg|jpeg|gif|svg|ico|mp3|wav|css|js)$ {
        expires 7d;
        add_header Cache-Control "public, max-age=604800";
    }
}
```

4) 重载 Nginx

```
sudo nginx -t && sudo systemctl reload nginx
```

5) 访问验证

- 浏览器访问 `http://example.com/` 应直接呈现 `Females/index.html` 页面。

## 部署方案 B：静态 + 后端 API（FastAPI/uvicorn，可选）

1) 后端环境

```
sudo apt install python3-pip python3-venv
python3 -m venv /srv/mhh-venv
source /srv/mhh-venv/bin/activate
pip install fastapi uvicorn
```

将 `backend/` 目录拷贝到服务器（例如 `/srv/mhh-backend`），并以 uvicorn 启动：

```
cd /srv/mhh-backend
uvicorn backend.app.main:app --host 127.0.0.1 --port 5552 --workers 1
```

可选：创建 systemd 服务（自动守护与开机启动）：

```
# /etc/systemd/system/mhh.service
[Unit]
Description=MHH FastAPI Service
After=network.target

[Service]
Type=simple
WorkingDirectory=/srv/mhh-backend
Environment="PATH=/srv/mhh-venv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin"
ExecStart=/srv/mhh-venv/bin/uvicorn backend.app.main:app --host 127.0.0.1 --port 5552 --workers 1
Restart=always

[Install]
WantedBy=multi-user.target
```

```
sudo systemctl daemon-reload
sudo systemctl enable mhh
sudo systemctl start mhh
```

2) Nginx 反向代理 `/api`（示例）

```
server {
    listen 80;
    server_name example.com;

    root /var/www/mhh/Females;
    index index.html;

    location / { try_files $uri $uri/ /index.html; }

    # 反向代理到 uvicorn
    location /api/ {
        proxy_pass http://127.0.0.1:5552;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

## 日常更新流程

- 前端更新：
  - 本地改好后，将 `Females/` 目录增量上传至 `/var/www/mhh/Females`。
  - 如涉及大量静态资源，建议用 `rsync` 保留更新时间戳：

    ```
    rsync -av --delete ./Females/ user@server:/var/www/mhh/Females/
    ```

- 后端更新：
  - 覆盖 `/srv/mhh-backend` 内代码并重启服务：

    ```
    sudo systemctl restart mhh
    ```

## 线上验证清单

- 页面加载：`index.html` 能正常打开，移动端画布四周为纯黑。
- 资源加载：图片、字体、音频无 404；字体若跨域需开启 `Access-Control-Allow-Origin`。
- 音频播放：确认服务器的 `mp3/wav` 有正确 MIME；Nginx 默认即可。
- API 代理：如启用后端，`/api` 路径能返回预期数据。

## 常见问题与修复建议

- 移动端画布边缘出现蓝线：
  - 已在页面内对移动端强制 `html/body` 背景纯黑，并为 `.map-card` 添加 `overflow: hidden`；如极端设备仍有 1px 泄露，可在 CSS 增加 `clip-path: inset(0 1px 0 0)` 到 `#canvas`，或确保容器宽/定位为整数像素。

- 字体/音频跨域：
  - 跨域部署时，在 Nginx 中为字体/音频资源添加 `Access-Control-Allow-Origin "*"`。

- 缓存更新不生效：
  - 对 CSS/JS 文件建议使用指纹（文件名或查询串），或在 Nginx 设置较短的缓存策略以便快速生效。

## 安全与性能建议

- 开启 HTTPS（Let's Encrypt / Certbot）。
- 为静态资源开启 gzip/压缩（`gzip on;`）。
- 后端设置 CORS（如跨域调用）与限流/日志。

---

如需要 Docker 化部署或将站点放在子路径（例如 `/game/`）下，请告知具体域名/路径，我可给出对应的配置模板。