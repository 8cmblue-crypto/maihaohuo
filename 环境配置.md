# 项目上线与调试方案（低资源版）

以下方案以“最不消耗服务器资源”为目标，优先沿用当前已完成的静态交互页面（例如 `Females/index.html`、`npc-game.js`、`reports.js`），只为必要的动态数据（排行榜与爆料）提供极简后端接口，并由 OpenResty 负责静态加速、反向代理与限流。

## 架构总览

- 前端（现状优先）
  - 继续使用现有静态页面与脚本，直接部署到 OpenResty 的静态目录。
  - 开发端口：`551`（可用简单静态服务，例如 `python3 -m http.server 551`）。
  - 通过原生 `fetch` 调用后端，避免额外依赖。

- 后端（极简）
  - 框架：FastAPI（异步，单进程即可）。
  - 端口：`552`，仅暴露必要接口：分数提交/排行榜、爆料提交/列表。
  - 数据库：SQLite（WAL 模式），小表+必要索引。
  - 违禁词：读取根目录 `mgc.txt`（启动时加载到内存），提交时二次校验。

- 网关：OpenResty（Nginx + Lua）
  - 静态资源统一由 OpenResty 直接服务（长缓存、Gzip/Brotli）。
  - 动态接口走反向代理到 `127.0.0.1:552`，对排行榜设置微缓存（例如 5s），对提交接口设置限流（每 IP 2r/s）。

## 接口定义（以现有功能为主）

- `POST /api/scores/submit`
  - body: `{ playerName, character, score, foundCount, ts }`
  - 校验：本地（前端）与服务端（后端）均做违禁词检查；分数范围与字段格式校验。
  - 返回：`{ ok: true, data: { id } }`。

- `GET /api/scores/leaderboard?page=1&limit=20`
  - 返回：`{ ok: true, data: { items: [...], total, page, limit } }`。
  - 由 OpenResty 对该 GET 接口做 3–5s 微缓存，显著降低后端压力。

- `POST /api/reports/submit`
  - body: `{ text, npc, pos: { x, y }, ts }`，文本违禁词过滤，长度限制例如 `<= 200`。
  - 返回：`{ ok: true, data: { id } }`。

- `GET /api/reports/list?page=1&limit=20`
  - 返回与排行榜类似的分页结构；可同样设置 3–5s 微缓存。

## SQLite 设置（节省资源）

- 启动时执行（建议在后端 init 内）：
  - `PRAGMA journal_mode=WAL;`
  - `PRAGMA synchronous=NORMAL;`
  - `PRAGMA cache_size=-20000;`（约 20MB 页缓存，按服务器内存自行调整）
  - `PRAGMA temp_store=MEMORY;`
  - `PRAGMA busy_timeout=3000;`
- 表与索引：
  - `scores(player_name, character, score, found_count, created_at)`，索引：`(score DESC)`、`(created_at DESC)`。
  - `reports(text, npc, x, y, created_at)`，索引：`(created_at DESC)`。
  - 定期 `VACUUM`（如每周一次，规模较小时可忽略）。

## 后端启动（低占用）

- 推荐命令：
  - `uvicorn app.main:app --host 127.0.0.1 --port 552 --workers 1 --loop uvloop --http httptools`
  - CORS：允许前端域名（例如同机 `http://localhost:551` 与生产域名）。
- 仅保留必要中间件；日志精简（JSON 体积小）。

## 前端对接（现有页面）

- `reports.js` / `npc-game.js` 中提交/查询时使用 `fetch`：
  - `fetch('/api/scores/submit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })`
  - 列表 `fetch('/api/scores/leaderboard?page=1&limit=20')`
- 违禁词：前端加载 `mgc.txt` 做一次本地校验，后端再校验一次（双保险）。

## OpenResty 配置示例（生产）

以下为单站点最小可用示例，假设静态根目录为 `/var/www/32_Characters`（将本项目拷贝至此），后端 FastAPI 在 `127.0.0.1:552`。

```
worker_processes auto;
events { worker_connections 1024; }

http {
  include       mime.types;
  default_type  application/octet-stream;
  sendfile      on;
  tcp_nodelay   on;
  keepalive_timeout  65;
  gzip on; gzip_types text/plain text/css application/json application/javascript image/svg+xml;
  # 如已安装 brotli，可开启：brotli on; brotli_types text/plain text/css application/json application/javascript image/svg+xml;

  # 静态缓存：7 天
  map $sent_http_content_type $static_expires {
    default                 1h;
    ~*text/html             1h;
    ~*text/css              7d;
    ~*application/javascript 7d;
    ~*image/                7d;
    ~*font/                 7d;
  }

  # 微缓存（排行榜/报告列表）
  proxy_cache_path /opt/1panel/apps/openresty/cache/micro levels=1:2 keys_zone=microcache:10m max_size=100m inactive=10m use_temp_path=off;

  # 提交接口限流：每 IP 2 次/秒，突发 4
  limit_req_zone $binary_remote_addr zone=scorelimit:10m rate=2r/s;

  upstream fastapi_backend { server 127.0.0.1:552; keepalive 16; }

  server {
    listen 80;
    server_name _;
    # 远程静态根目录：/opt/1panel/apps/openresty/openresty/www/sites/xiangsu/index
    root /opt/1panel/apps/openresty/openresty/www/sites/xiangsu/index;

    # 静态首页：现有页面位于 Females/index.html
    location = / { try_files $uri /Females/index.html; }
    location /Females/ {
      try_files $uri $uri/ =404;
      expires $static_expires;
      add_header Cache-Control "public";
    }

    # API 反向代理
    location /api/ {
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_pass http://fastapi_backend;
      client_max_body_size 64k;
      proxy_read_timeout 10s;
    }

    # 排行榜与报告列表微缓存（GET）
    location ~ ^/api/(scores/leaderboard|reports/list) {
      proxy_cache microcache;
      proxy_cache_valid 200 5s;
      proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
      add_header X-Cache-Status $upstream_cache_status;
      proxy_pass http://fastapi_backend;
    }

    # 分数/爆料提交限流（POST）
    location ~ ^/api/(scores/submit|reports/submit)$ {
      limit_req zone=scorelimit burst=4 nodelay;
      proxy_pass http://fastapi_backend;
    }
  }
}
```

## 本地调试

- 前端：
  - `python3 -m http.server 551`（或保留 IDE 提供的本地预览）。
  - 打开 `http://localhost:551/Females/index.html`。

- 后端：
  - `uvicorn app.main:app --host 127.0.0.1 --port 552 --workers 1 --loop uvloop --http httptools`。
  - `.env` 中暴露：`PORT=552`、`DATABASE_URL=sqlite:///./data.db`。

## 资源优化要点

- 静态优先：所有图片、音频、字体、脚本由 OpenResty 直接服务，长缓存；避免经过后端。
- 微缓存 GET：排行榜与报告列表设置 3–5s 微缓存，极大降低数据库读取频次。
- 单进程后端：FastAPI 单进程+异步即可承载本量级，避免多进程占用内存。
- SQLite 优化：WAL 模式、必要索引、短超时；数据量较小时无需拆库。
- 限流与防刷：对提交接口按 IP 限流；前端也可增加最小间隔提交限制。
- 精简日志：静态资源关闭详细日志（或按需），动态接口保留必要审计。

## 部署步骤（建议）

1) 将本项目拷贝至服务器 `/var/www/32_Characters`（确认 `Females/index.html` 可访问）。
2) 启动后端：`uvicorn` 绑定 `127.0.0.1:552`。
3) 按上方示例配置 OpenResty 并重载：`systemctl reload openresty`。
4) 验证：访问站点首页与接口；观察 `X-Cache-Status`、限流是否生效。

以上内容以现有功能为主，尽量避免引入复杂依赖。后续若需要引入 Vue3/Vite，可保持端口 `551` 不变，由 OpenResty 继续作为统一入口与静态加速层。